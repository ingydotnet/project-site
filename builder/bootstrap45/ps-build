#!/usr/bin/env bash

# shellcheck disable=2030,2031

set -e -u -o pipefail

main() (
  i=/input
  o=/output
  r=$PWD
  t=$r/template
  s=$r/site

  setup-site

  build-site

  [[ ${1-} == --local ]] && return

  publish-site
)

setup-site() (
  check-directory $i Input

  setup-config
  setup-theme
  setup-data
  setup-pages
  setup-files
  setup-favicon
)

setup-config() (
  # Create the _config.yml file:
  set -x
  ps-config \
    "$t/_config.yml" \
    /input/ps-config.yaml \
    > _config.yml
)

setup-theme() (
  # Set theme color:
  set -x
  render-template \
    site/assets/scss/_variables.scss \
    /input/ps-config.yaml
)

setup-data() (
  # Copy over Markdown and YAML source files:
  find $i -name 'ps-*.yaml' -print |
    while read -r file; do
      name=${file#$i/}
      name=${name%.yaml}
      name=${name//\//__}
      if [[ $file == *ps-config* ]]; then
        navbar=$(y2j < "$file" | jq .navbar)
        if [[ $navbar && $navbar != null ]]; then
          nav_name=${name/ps-config/navbar}
          echo "$navbar" | j2y > "$s/_data/$nav_name.yaml"
        fi
        if ! grep -q 'sidebar: false' "$file"; then
          sidebar=$(y2j < "$file" | jq .sidebar)
          if [[ $sidebar && $sidebar != null ]]; then
            side_name=${name/ps-config/sidebar}
            echo "$sidebar" | j2y > "$s/_data/$side_name.yaml"
          fi
        fi
      else
        name=${name/ps-/}
        cp -f "$file" "$s/_data/$name.yaml"
      fi
    done
)

setup-pages() (
  # Copy over Markdown source files:
  find "$i" -name ReadMe.md -prune -o -name '*.md' -print |
    while read -r file; do
      setup-page "$file" "${file%/*}"
    done

  find "$i" -name ps-config.yaml -prune -o -name '*.yaml' -print |
    while read -r file; do
      path=$(create-page "$file")
      if [[ $path ]]; then
        setup-page "${path}" "${file%/*}"
      fi
    done
)

create-page() (
  yaml=$1
  md=${yaml%.yaml}.md
  dir=/tmp/${md#/*/}
  dir=${dir%/*}
  mkdir -p "$dir"
  page=$dir/${md##*/}
  front=$(perl -ne 'print unless /^---$/' "$yaml")

  if [[ -f $md ]]; then
    grep -q '^content-url:' "$yaml" &&
      die "'$yaml' contains 'content-url' key, but '$md' already exists."
    grep -q '^---$' "$md" &&
      die "'$md' may not contain front matter when '$yaml' exists."
    body=$(< "$md")

  else
    url=$(grep '^content-url:' "$yaml" | awk '{print $2}' || true)

    [[ $url ]] ||
      die "'$yaml' doesn't have a 'content-url' entry"

    body=$(curl -s "$url") ||
      die "Failed to fetch 'content-url' content from '$url'"
  fi

  echo "$page"
  cat <<... > "$page"
---
$front
---
$body
...
)

setup-page() (
  md_file=$1
  src_path=$2
  out_file=$s/${md_file#/*/}

  # shellcheck disable=2046,2086
  set -- $(IFS=/; echo ${md_file%/*})
  configs=()

  navbar=
  sidebar=
  data=''

  [[ -e $s/_data/navbar.yaml ]] && navbar=navbar
  if [[ -e $s/_data/sidebar.yaml ]] &&
     ! grep -q 'sidebar: false' "$s/_data/sidebar.yaml"
  then
    sidebar=sidebar
  fi

  path=''
  while [[ $# -gt 0 ]]; do
    dir=$1; shift
    path+=/$dir

    [[ $path == "$i" ]] || data+=${dir}__

    if [[ -e $s/_data/${data}navbar.yaml ]]; then
      navbar=${data}navbar
    fi
    if [[ -e $s/_data/${data}sidebar.yaml ]]; then
      sidebar=${data}sidebar
    fi

    config=$path/ps-config.yaml
    [[ -f $config ]] && configs+=("$config")
  done

  get-levels "$src_path"

  export navbar sidebar
  export level1 level2 level3

  mkdir -p "$(dirname "$out_file")"

  (
    set -x
    ps-page "$md_file" "${configs[@]}" > "$out_file"
  )
)

get-levels() {
  level1='' level2='' level3=''
  path=$1/
  path=${path#/*/}
  [[ $path ]] || return 0

  # XXX fix this shellcheck later. Might require bash 4.4+.
  # shellcheck disable=2207,2086
  levels=($(IFS=/; echo $path))
  level1=${levels[0]-}
  level2=${levels[1]-}
  level3=${levels[2]-}
}

setup-files() (
  if [[ -d $i/ps-layout ]]; then
    ( set -x; cp -fr $i/ps-layout/* "$s/_layouts/" )
  fi

  if [[ -d $i/ps-include ]]; then
    ( set -x; cp -fr $i/ps-include/* "$s/_includes/" )
  fi

  if [[ -d $i/ps-data ]]; then
    ( set -x; cp -fr $i/ps-data/* "$s/_data/" )
  fi
)

setup-favicon() (
  if [[ $(y2j < "$r/_config.yml" |
          jq 'select(.["ps-theme"].logo.letters)'
     ) ]]
  then
    (echo site:; perl -pe 's/^/  /' "$r/_config.yml") > /tmp/config.yaml
    liquidize /tmp/config.yaml "$s/_includes/icons/logo.svg" \
      > "$s/favicon.svg"
  fi
)

render-template() (
  template=$1 data=$2
  ps-render \
    "template/$template" \
    "$data" \
    > "$template"
)

build-site() (
  set -x

  npm run build

  bundle exec jekyll build --config=_config.yml
)

publish-site() (
  check-directory $o Output

  set -x

  (
    cd $o
    find . -path './.git*' -prune -o -name CNAME -prune -o -path './*' -print0 |
      xargs rm -fr
  )

  (
    cd _gh_pages

    find . -path './.git*' -prune -o -path './*' -print |
      cpio -dump $o
  )

  date > $o/.project-site-build
)

check-directory() (
  [[ -d $1 ]] ||
    die "Error: $2 directory '$1' does not exist"
)

j2y() (
  node -e '
    const fs = require("fs");
    const yaml = require("yaml");
    const j = fs.readFileSync("/dev/stdin").toString()
    const y = yaml.stringify(JSON.parse(j));
    fs.writeFileSync("/dev/stdout", y);
  '
)

y2j() (
  node -e '
    const fs = require("fs");
    const yaml = require("yaml");
    const y = fs.readFileSync("/dev/stdin").toString()
    const j = JSON.stringify(yaml.parse(y));
    fs.writeFileSync("/dev/stdout", j);
  '
)

die() (printf "%s\n" "$@" >&2; exit 1)

main "$@"
